version: "3.9"

# Development compose override
services:
  postgres:
    ports:
      - "5432:5432"

  redis:
    ports:
      - "6379:6379"

  # Backend in development mode with hot-reload
  api:
    build:
      context: .
      dockerfile: server/Dockerfile.dev
    container_name: nimora-api-dev
    environment:
      NODE_ENV: development
      PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_USER:-nimora}:${POSTGRES_PASSWORD:-nimora_secret}@postgres:5432/${POSTGRES_DB:-nimora}?schema=public
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-nimora_redis_secret}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-dev_jwt_access_secret_change_in_production}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-dev_refresh_secret_change_in_production}
      ECAMPUS_BASE_URL: ${ECAMPUS_BASE_URL:-https://ecampus.psgtech.ac.in}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-dev_encryption_key_32chars!}
    volumes:
      - ./server/src:/app/server/src:ro
    ports:
      - "3001:3001"
      - "9229:9229" # Debug port
    command: pnpm run start:dev

  # Frontend in development mode with hot-reload
  frontend:
    build:
      context: .
      dockerfile: client/Dockerfile.dev
    container_name: nimora-frontend-dev
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3001/api
    volumes:
      - ./client/src:/app/client/src:ro
      - ./packages:/app/packages:ro
    ports:
      - "3000:3000"
    command: pnpm run dev
